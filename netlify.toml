# PFF Protocol - Netlify Configuration for Next.js 16
# Using Netlify's Next.js Runtime (Essential Next.js plugin)

[build]
  base = "web"
  command = "npm run build"

[build.environment]
  NODE_VERSION = "20"
  NEXT_TELEMETRY_DISABLED = "1"
  NODE_OPTIONS = "--max-old-space-size=4096"
  NPM_FLAGS = "--legacy-peer-deps"

# Required in Netlify UI (Site → Build & deploy → Environment):
# NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY

# Allow GPS, camera, mic for Quad-Pillar Shield (browsers block without this)
[[headers]]
  for = "/*"
  [headers.values]
    Permissions-Policy = "camera=(self), microphone=(self), geolocation=(self)"

# Functions live in web/netlify/functions (relative to base when base = "web")
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

# Edge: Sovereign Companion responds from the data center closest to the user
[[edge_functions]]
  function = "sovereign-heartbeat"
  path = "/api/sovereign-edge"

# Rewrite /api/identity-reset to Netlify Function so Reset Identity clears Supabase on live site
[[redirects]]
  from = "/api/identity-reset"
  to = "/.netlify/functions/identity-reset"
  status = 200
  force = true

# Vitalization status: static export has no API routes; serve via Netlify Function
[[redirects]]
  from = "/api/v1/vitalization-status"
  to = "/.netlify/functions/vitalization-status"
  status = 200
  force = true

# Device binding (Face + Passkey): save pillars and sovereign root — static export has no API routes
[[redirects]]
  from = "/api/v1/save-pillars-at-75"
  to = "/.netlify/functions/save-pillars-at-75"
  status = 200
  force = true
[[redirects]]
  from = "/api/v1/save-sovereign-root"
  to = "/.netlify/functions/save-sovereign-root"
  status = 200
  force = true

# Sovereign Companion search: static export has no API routes; serve via Netlify Function (no 404)
[[redirects]]
  from = "/api/sovereign-recognition"
  to = "/.netlify/functions/sovereign-recognition"
  status = 200
  force = true
[[redirects]]
  from = "/api/sovereign-recognition/"
  to = "/.netlify/functions/sovereign-recognition"
  status = 200
  force = true
