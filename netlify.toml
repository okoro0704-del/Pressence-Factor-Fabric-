# PFF — Netlify must BUILD the web app (do not use "Deploy without building" or "Skip builds").
# If deploy log shows Building: Skipped / Deploying: Skipped, see docs/NETLIFY-FIX-SKIPPED-BUILD.md
#
# When this repo is connected to Netlify, base directory must be "web" so build runs there.
# DEPLOY TO BOTH URLS: One deploy serves BOTH the Netlify app URL and your custom domain.
# Supabase: add both your custom domain and https://*.netlify.app to Auth URL / Redirect URLs.

[build]
  base = "web"
  command = "npm run build"
  publish = "out"
  # Ignore nothing; ensure build runs (Netlify UI must NOT have "Skip builds" enabled)

[build.environment]
  NODE_VERSION = "20.10.0"
  NEXT_TELEMETRY_DISABLED = "1"
  NETLIFY_NEXT_PLUGIN_SKIP = "true"
  NODE_OPTIONS = "--max-old-space-size=4096"

# Required in Netlify UI (Site → Build & deploy → Environment):
# NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY

# Allow GPS, camera, mic for Quad-Pillar Shield (browsers block without this)
[[headers]]
  for = "/*"
  [headers.values]
    Permissions-Policy = "camera=(self), microphone=(self), geolocation=(self)"

# Functions live in web/netlify/functions (relative to base)
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

# Edge: Sovereign Companion responds from the data center closest to the user
[[edge_functions]]
  function = "sovereign-heartbeat"
  path = "/api/sovereign-edge"

# Rewrite /api/identity-reset to Netlify Function so Reset Identity clears Supabase on live site
[[redirects]]
  from = "/api/identity-reset"
  to = "/.netlify/functions/identity-reset"
  status = 200
  force = true

# Sovereign Companion search: static export has no API routes; serve via Netlify Function (no 404)
[[redirects]]
  from = "/api/sovereign-recognition"
  to = "/.netlify/functions/sovereign-recognition"
  status = 200
  force = true
[[redirects]]
  from = "/api/sovereign-recognition/"
  to = "/.netlify/functions/sovereign-recognition"
  status = 200
  force = true
